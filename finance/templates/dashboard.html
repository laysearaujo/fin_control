{% extends 'base.html' %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-5 bg-white p-3 rounded shadow-sm">
    <a href="{{ mes_ant_url }}" class="btn btn-outline-dark">&laquo; Anterior</a>
    
    <div class="text-center">
        <h2 class="fw-bold m-0 text-capitalize">{{ data_ref|date:"F Y" }}</h2> 
        <small class="text-muted">
            {% if eh_passado %}Hist√≥rico Fechado{% elif eh_futuro %}Previs√£o Futura{% else %}M√™s Atual (Em Andamento){% endif %}
        </small>
    </div>
    
    <a href="{{ prox_mes_url }}" class="btn btn-outline-dark">Pr√≥ximo &raquo;</a>
</div>

<div class="row mb-4">
    
    <div class="col-md-3">
        <div class="card card-custom p-3 bg-light border-start border-4 border-secondary h-100 shadow-sm">
            <h6 class="text-muted small">‚èÆÔ∏è Veio do m√™s anterior</h6>
            <h3 class="fw-bold {% if saldo_anterior < 0 %}text-danger{% else %}text-dark{% endif %}">
                R$ {{ saldo_anterior|floatformat:2 }}
            </h3>
            <small class="text-muted">Acumulado hist√≥rico</small>
        </div>
    </div>

    {% if eh_passado %}
        <div class="col-md-3">
            <div class="card card-custom p-3 bg-white h-100 shadow-sm">
                <h6 class="text-success small">üí∞ Entrou (Real)</h6>
                <h3 class="fw-bold text-success">R$ {{ receitas_reais_mes|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-custom p-3 bg-white h-100 shadow-sm">
                <h6 class="text-danger small">üí∏ Saiu (Real)</h6>
                <h3 class="fw-bold text-danger">R$ {{ saidas_reais_mes|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-custom p-3 bg-secondary text-white h-100 shadow-sm">
                <h6 class="text-white-50 small">üèÅ Fechamento</h6>
                <h3 class="fw-bold">R$ {{ saldo_real_atual|floatformat:2 }}</h3>
                <small class="text-white-50">Saldo final deste m√™s</small>
            </div>
        </div>

    {% elif eh_futuro %}
        <div class="col-md-3">
            <div class="card card-custom p-3 bg-white border-start border-4 border-success h-100 shadow-sm">
                <h6 class="text-muted small">üí∞ Receitas Previstas</h6>
                <h3 class="fw-bold text-success">R$ {{ total_receitas_previsto|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-custom p-3 bg-white border-start border-4 border-danger h-100 shadow-sm">
                <h6 class="text-muted small">üìâ Sa√≠das Previstas</h6>
                <h3 class="fw-bold text-danger">R$ {{ total_saidas_previsto|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-custom p-3 bg-white border-start border-4 border-primary h-100 shadow-sm">
                <h6 class="text-muted small">üîÆ Proje√ß√£o Final</h6>
                <h3 class="fw-bold text-primary">R$ {{ saldo_projetado|floatformat:2 }}</h3>
            </div>
        </div>

    {% else %}
        <div class="col-md-3">
            <div class="card card-custom p-3 bg-dark text-white h-100 shadow">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="text-white-50 m-0">üè¶ Saldo Hoje (Real)</h6>
                    <span class="badge bg-success">Agora</span>
                </div>
                <h2 class="fw-bold">R$ {{ saldo_real_atual|floatformat:2 }}</h2>
                <small class="text-white-50">Dispon√≠vel no bolso</small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-custom p-3 bg-white border-start border-4 border-danger h-100 shadow-sm">
                <h6 class="text-muted small">‚ö†Ô∏è A Pagar (Restante)</h6>
                <h3 class="fw-bold text-danger">R$ {{ total_restante_a_pagar|floatformat:2 }}</h3>
                <small class="text-muted">Contas Pendentes + Fatura</small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-custom p-3 bg-white border-start border-4 border-primary h-100 shadow-sm opacity-75">
                <h6 class="text-muted small">üîÆ Previs√£o Fim do M√™s</h6>
                <h3 class="fw-bold text-primary">R$ {{ saldo_projetado|floatformat:2 }}</h3>
                <small class="text-muted">Saldo Hoje - Restante a Pagar</small>
            </div>
        </div>
    {% endif %}
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card card-custom p-3 bg-success text-white shadow-sm d-flex flex-row justify-content-between align-items-center">
            <div>
                <h5 class="m-0 fw-bold">üêñ Dinheiro Guardado (Caixinhas)</h5>
                <small class="text-white-50">Reserva, Metas e Investimentos</small>
            </div>
            <div class="text-end">
                <h2 class="fw-bold m-0">R$ {{ total_investido|floatformat:2 }}</h2>
                <a href="{% url 'caixinhas' %}" class="btn btn-sm btn-light text-success fw-bold mt-1">Gerenciar Caixinhas</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    
    <div class="col-md-6">
        <div class="card card-custom p-4 h-100 shadow-sm">
            <div class="d-flex justify-content-between mb-3 align-items-center">
                <h5 class="fw-bold m-0">üè† Contas {% if eh_passado %}Fechadas{% else %}do M√™s{% endif %}</h5>
                
                {% if not eh_passado %}
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-primary fw-bold" data-bs-toggle="modal" data-bs-target="#modalContaAvulsa" title="Adicionar conta s√≥ para este m√™s">
                        + Extra
                    </button>
                    <a href="{% url 'gerenciar_fixos' %}" class="btn btn-sm btn-outline-secondary">Editar Fixas</a>
                </div>
                {% endif %}
            </div>
            
            <div class="table-responsive">
                <table class="table align-middle">
                    <tbody>
                        {% for item in lista_fixos_detalhada %}
                        <tr>
                            <td>
                                <div class="fw-bold text-dark">
                                    {{ item.nome }}
                                    {% if item.eh_cartao %}
                                        <span class="badge bg-warning text-dark" style="font-size: 0.7em">üí≥ Cart√£o</span>
                                    {% endif %}
                                    {% if item.tipo == 'avulsa' %}
                                        <span class="badge bg-primary bg-opacity-75" style="font-size: 0.7em">Extra</span>
                                    {% endif %}
                                </div>
                                
                                {% if item.status == 'pago' %}
                                    <small class="text-success fw-bold">Pago!</small>
                                {% else %}
                                    {% if eh_passado %}
                                        <small class="text-danger fw-bold">N√£o pago</small>
                                    {% else %}
                                        <small class="text-muted">Vence dia {{ item.dia }}</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            
                            <td class="text-end">
                                {% if item.status == 'pago' %}
                                    <div class="text-success fw-bold">R$ {{ item.valor_pago }} ‚úÖ</div>
                                {% else %}
                                    
                                    {% if eh_passado %}
                                        <span class="text-danger fw-bold"> Pendente </span>
                                    {% else %}
                                        
                                        {% if item.eh_cartao %}
                                            <div class="d-flex flex-column align-items-end">
                                                <span class="fw-bold text-muted">R$ {{ item.valor_previsto }}</span>
                                                <span class="badge bg-warning text-dark border" style="font-size: 0.7em">No Cart√£o üîí</span>
                                            </div>
                                        {% else %}
                                            
                                            <div class="d-flex align-items-center justify-content-end gap-2">
                                                <div class="fw-bold text-dark">R$ {{ item.valor_previsto }}</div>

                                                {% if item.tipo == 'avulsa' %}
                                                    <div class="btn-group">
                                                        <a href="{% url 'pagar_conta_avulsa' item.id %}?mes={{ data_ref.month }}&ano={{ data_ref.year }}" 
                                                           class="btn btn-sm btn-outline-primary rounded-pill px-3 py-0" style="font-size: 0.85rem;">
                                                           Pagar
                                                        </a>
                                                        <button type="button" class="btn btn-sm btn-link text-secondary p-0 ms-2" data-bs-toggle="modal" data-bs-target="#modalEditar{{ item.id }}">
                                                            ‚úèÔ∏è
                                                        </button>
                                                        <a href="{% url 'apagar_conta_avulsa' item.id %}" 
                                                           class="btn btn-sm btn-link text-danger p-0 ms-1"
                                                           onclick="return confirm('Tem certeza que quer apagar essa conta extra?')">
                                                            üóëÔ∏è
                                                        </a>
                                                    </div>

                                                    <div class="modal fade text-start" id="modalEditar{{ item.id }}" tabindex="-1">
                                                        <div class="modal-dialog modal-dialog-centered">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title fw-bold">Editar Conta</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <form action="{% url 'editar_conta_avulsa' item.id %}" method="POST">
                                                                    {% csrf_token %}
                                                                    <div class="modal-body">
                                                                        <div class="mb-3">
                                                                            <label>Nome</label>
                                                                            <input type="text" name="titulo" class="form-control" value="{{ item.nome }}" required>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label>Valor (R$)</label>
                                                                            <input type="number" step="0.01" name="valor" class="form-control" value="{{ item.valor_previsto|stringformat:'.2f' }}" required>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label>Data Vencimento</label>
                                                                            <input type="date" name="data_vencimento" class="form-control" value="{{ data_ref.year }}-{{ data_ref.month|stringformat:'02d' }}-{{ item.dia|stringformat:'02d' }}" required>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label>Categoria</label>
                                                                            <select name="categoria_id" class="form-select">
                                                                                {% for cat in categorias %}
                                                                                    <option value="{{ cat.id }}">{{ cat.nome }}</option>
                                                                                {% endfor %}
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                                                                    </div>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% else %}
                                                    <a href="{% url 'pagar_gasto_fixo' item.id %}?mes={{ data_ref.month }}&ano={{ data_ref.year }}" 
                                                       class="btn btn-sm btn-outline-success rounded-pill px-3 py-0" style="font-size: 0.85rem;">
                                                       Pagar
                                                    </a>
                                                {% endif %}
                                            </div>

                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="2" class="text-muted text-center py-4">Nenhuma conta cadastrada.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card card-custom p-4 h-100 shadow-sm">
            
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="fw-bold mb-1">üí≥ Fatura {% if eh_passado %}Fechada{% else %}Estimada{% endif %}</h5>
                    <p class="text-muted small mb-3">Vencimento em <strong>{{ data_ref|date:"F" }}</strong></p>
                </div>
                <button type="button" class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalFatura">
                    üëÅÔ∏è Ver Itens
                </button>
            </div>
            
            {% if fatura_paga %}
                <div class="alert alert-success text-center py-4 mb-0">
                    <h1 class="display-4 mb-0">‚úÖ</h1>
                    <h3 class="fw-bold text-success">Fatura Paga!</h3>
                    <p class="mb-0">Total quitado: <strong>R$ {{ total_cartao|floatformat:2 }}</strong></p>
                </div>

            {% else %}
                <div class="alert alert-warning text-center">
                    <h2 class="fw-bold m-0 text-dark">R$ {{ total_cartao|floatformat:2 }}</h2>
                    <small>Total Somado</small>
                </div>
                
                {% if not eh_passado and total_cartao > 0 %}
                    <button type="button" class="btn btn-dark w-100 mb-2" data-bs-toggle="modal" data-bs-target="#modalConfirmarPgto">
                       ‚úÖ Pagar Fatura Agora
                    </button>
                {% endif %}
            {% endif %}

            {% if not fatura_paga %}
                <a href="{% url 'gerenciar_cartoes' %}" class="btn btn-sm btn-outline-secondary w-100 mt-auto">Gerenciar Cart√µes</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmarPgto" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold">üí∏ Confirmar Pagamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <h5 class="mb-3">Voc√™ vai pagar a fatura de <strong>{{ data_ref|date:"F/Y" }}</strong>?</h5>
                <h1 class="text-danger fw-bold my-3">R$ {{ total_cartao|floatformat:2 }}</h1>
                <p class="text-muted">Esse valor ser√° descontado do seu saldo atual.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                <a href="{% url 'pagar_fatura_mensal' %}?mes={{ data_ref.month }}&ano={{ data_ref.year }}" class="btn btn-success px-5 fw-bold">
                    Sim, Pagar!
                </a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFatura" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Detalhes da Fatura ({{ data_ref|date:"F/Y" }})</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="list-group list-group-flush">
                    {% for item in itens_fatura_detalhe %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            {{ item.desc }}
                            {% if item.tipo == 'fixo' %}
                                <span class="badge bg-info text-dark" style="font-size:0.7em">Assinatura</span>
                            {% endif %}
                        </div>
                        <span class="fw-bold">R$ {{ item.valor }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center text-muted">Nada consta nesta fatura.</li>
                    {% endfor %}
                </ul>
                <hr>
                <div class="d-flex justify-content-between px-3">
                    <strong>TOTAL:</strong>
                    <strong class="text-danger">R$ {{ total_cartao|floatformat:2 }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalContaAvulsa" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Adicionar Conta Pontual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'adicionar_conta_avulsa' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted small">Esta conta aparecer√° <strong>apenas</strong> no m√™s de {{ data_ref|date:"F/Y" }}.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Nome da Conta</label>
                        <input type="text" name="titulo" class="form-control" placeholder="Ex: Pagar Irm√£, Conserto Carro" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Valor (R$)</label>
                        <input type="number" step="0.01" name="valor" class="form-control" placeholder="0,00" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Categoria</label>
                        <select name="categoria_id" class="form-select" required>
                            <option value="" selected disabled>Selecione...</option>
                            {% for cat in categorias %}
                                <option value="{{ cat.id }}">{{ cat.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Data de Vencimento</label>
                        <input type="date" name="data_vencimento" class="form-control" value="{{ data_ref|date:'Y-m-01' }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Conta</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}